name: CI

on:
  push:
    branches: [ main, develop, '**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    name: Validate + Lint
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install linters
      run: |
        python -m pip install --upgrade pip
        pip install flake8 yamllint

    - name: Run Python syntax check
      run: |
        python -m py_compile ping-agent/ping_agent.py || true
        python -m py_compile http-agent/http_agent.py || true

    - name: Run flake8 (agents)
      run: |
        # não falhar em imports ausentes do ambiente de container
        flake8 --max-line-length=120 ping-agent http-agent || true

    - name: Lint YAML files
      run: |
        yamllint -c /dev/null prometheus || true
        yamllint -c /dev/null grafana/provisioning || true
        yamllint -c /dev/null docker-compose.yml || true

    - name: Validate docker-compose
      run: |
        # valida a sintaxe do compose (requer docker no runner)
        docker compose -f docker-compose.yml config

    - name: Validate Prometheus config (promtool)
      run: |
        # usa a imagem oficial do Prometheus para validar o prometheus.yml
        # o entrypoint da imagem é 'prometheus', portanto passamos promtool via --entrypoint
        docker run --rm -v ${GITHUB_WORKSPACE}/prometheus:/prometheus --entrypoint=/bin/promtool prom/prometheus:latest check config /prometheus/prometheus.yml
